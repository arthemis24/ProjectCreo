{% load i18n staticfiles %}
<script>
    $("#menu-toggle").click(function(e) {
        e.preventDefault();
        $("#wrapper").toggleClass("toggled");
    });

    (function() {
        // Here is the application Initialisation zone; We will manage UI viewer; and default configs

        var markerCount = 0, map, city, zone, fiberStatus, fiberType, deviceStatus, deviceCategory, searchVal ='', string_date='',lastMarkerId, clickListener;
        ikwen.index = -1;
        ikwen.fiberData;
        ikwen.fiberListIds = [];
        ikwen.deviceListIds = [];
        ikwen.eventData = [];
        ikwen.polylines = [];
        ikwen.eventDataCount = 0;
        ikwen.markerList = [];
        ikwen.currentMarkerListOnTheMap = [];
        ikwen.currentMarkerDataListOnTheMap = [];
        ikwen.startDragPosition = {};
        var lastFiberId = "{{ last_fiber_id }}",
            lastDeviceId = "{{ last_device_id }}"
{#        localStorage.setItem("lastLat", "Smith");#}
{#        localStorage.setItem("lastLng", "Smith");#}
        // load initial map options
        var myLatlng = new google.maps.LatLng(3.8879017, 11.5348783);
        var map_canvas = document.getElementById('page-content-wrapper');
        var options = {
            center: myLatlng, zoom: 13,
            mapTypeId: google.maps.MapTypeId.ROADMAP
        };


        function initialize(map_options) {
            map = new google.maps.Map(map_canvas, map_options);
        }
        infowindow = new google.maps.InfoWindow();

        initialize(options);
        checkDataIntegrity()
        loadAllEquipments();
        // Select if the user just want the equipments viewer interface or the the live drawing one
        $('span#live-drawing').click(function (e) {
            $('button#save-fiber-modification').hide()
            unsetMarkers();
            unsetPolylines();
            initLiveDrawingUI()
        });
         $('span#view-all-equipments').click(function (e) {
             $('button#save-fiber-modification').hide()
            $('#current-polyline-length').hide()
             unsetMarkers();
             unsetPolylines();
             prepareDefaultUI();
             loadAllEquipments()
            checkDataIntegrity()
        });
        $('li#back-to-equipment').click(function (e) {
            $('button#save-fiber-modification').hide()
            $('#current-polyline-length').hide()
            unsetMarkers();
            unsetPolylines();
            loadAllEquipments()
            checkDataIntegrity()
            $('div#ld-tools-content').fadeOut("slow", function (e) {
                $('#equipement-viewer').show().removeClass('hidden')
            }).hide()
        });
        $('form#line-search input#line-keyword').autocomplete({
            serviceUrl: "{% url 'find_lines' %}",
            //minChars: 2,
            appendTo: '#suggestions-for-lines',
            onSelect: function(suggestion) {
                var data = suggestion.value.split(' ')[0];
                $('form#line-search input:hidden').val(data);
{#                    $('#location').submit()#}
                $('div#suggestions-for-lines div.autocomplete-suggestions').css('width','340px');
                $('div#suggestions-for-lines div.autocomplete-suggestions').css('overflow-x','hidden')
            }
        });
        $('button#done').click(function(){
            activateLineOptimizing()
        });
        var latitude, longitude, deviceId, htmlText,iconImg;



{#    Home page for fibelines and network equipments viewer. here there are several function #}
{#    Transform theses two loading part into callable function; cuz they are needed elsewhere #}
         function notifyLoadFinished() {
            blocksLoaded++;
            var rate = Math.round(blocksLoaded / totalBlocks * 100) + '%';
            $('.progress-rate').text(rate);
            if (blocksLoaded >= totalBlocks) {
                $('.loading-progress').hide();
            }
        }

        function loadAllEquipments() {
            var i, j,
                localFibers = localStorage.getItem("fiberlines"),
                localDevices = localStorage.getItem("devices");
            if (localFibers && localDevices) {
{#                console.log("localFibers " + localFibers);#}
{#                console.log("localFibersJSON " + JSON.parse(localFibers));#}
                localFibers = JSON.parse(localFibers);
                ikwen.fiberData = localFibers
                drawPoly(localFibers);

                localDevices = JSON.parse(localDevices);
                var d;
                for (i=0; i<localDevices.length; i++) {
                    d = localDevices[i];
                    html =  '';
                    addMarkerToMap(d.lat, d.lng, d.id, html, d.icon);
                }
                $('.loading-progress').hide();

                try {
                    lastFiberId = localFibers[0]['fiberline'].id;
                    var currentId;
                    for (i=0; i<localFibers.length; i++) {
                        currentId = localFibers[i]['fiberline'].id;
                        if (currentId > lastFiberId) lastFiberId = currentId
                    }
                    console.log("Last fiber ID: " + lastFiberId);

                    lastDeviceId = localDevices[0].id;
                    for (i=0; i<localDevices.length; i++) {
                        currentId = localDevices[i].id;
                        if (currentId > lastDeviceId) lastDeviceId = currentId
                    }
                    console.log("Last device ID: " + lastDeviceId);
                } catch (e) {}

                return
            }

            var blocksLoaded = 0,
                localFiberData,
                localDeviceData,
                fiberBlocks = {{ fiber_blocks }},
                deviceBlocks = {{ device_blocks }},
                device_count = {{ devices_count }},
                totalBlocks = fiberBlocks + deviceBlocks;
            $('.progress-rate').text('0 %');
            for (i=0; i<fiberBlocks; i++) {
                $.getJSON('{ url 'grab_fibers' %}', {start: i * 50}, function(data) {
                    if (localFiberData) {
                        var end = localFiberData.length - 1;
                        localFiberData = localFiberData.substr(0, end) + ',' + JSON.stringify(data).substring(1);
                    } else
                        localFiberData = JSON.stringify(data);
                    localStorage.setItem("fiberlines", localFiberData);
                    drawPoly(data);

                    blocksLoaded++;
                    var rate = Math.round(blocksLoaded / totalBlocks * 100) + '%';
                    $('.progress-rate').text(rate);
                    if (blocksLoaded >= totalBlocks) {
                        $('.loading-progress').hide();
                    }
                });
            }

            for (i=0; i<deviceBlocks; i++) {
                    console.log('Block: ' + i)
                $.getJSON('{% url 'grab_devices' %}', {start: i * 50}, function(data) {
                    if (localDeviceData) {
                        var end = localDeviceData.length - 1;
                        localDeviceData = localDeviceData.substr(0, end) + ',' + JSON.stringify(data).substring(1);
                    } else
                        localDeviceData = JSON.stringify(data);
                    localStorage.setItem("devices",localDeviceData);
                    var d;
                    for (j=0; j<data.length; j++) {
                        d = data[j];
                        html =  '';
                        addMarkerToMap(d.lat, d.lng, d.id, html, d.icon);
                    }
                   blocksLoaded++;
                    var rate = Math.round(blocksLoaded / totalBlocks * 100) + '%';
                    $('.progress-rate').text(rate);
                    if (blocksLoaded >= totalBlocks) {
                        $('.loading-progress').hide();
                    }
                });
            }
        }

        $("button#save-device").click(function () {
            latitude = $('form#equipment input.latitude').val();
            longitude = $('form#equipment input.longitude').val();
            var desc = $('form#equipment textarea.desc').val();
            var category = $('form#equipment .category').val();
            if (latitude == '' || longitude == '' || category == ''){
                alert('Incomplete data; recheck again please !');
                $('form#equipment textarea.desc').focus();
                return false
            }else {
                saveEquipment(category, latitude, longitude, desc);
                closeLightbox();
                return false
            }
        });


        $('section.cities li.city a').click(function() {
            $('section.cities li.city a').removeClass('active');
            $(this).addClass('active');
            var lat = $(this).data('lat'), lng = $(this).data('lng');
            var myLatLng = new google.maps.LatLng(lat, lng);
            map.panTo(myLatLng)
        });

        $('input#daterange').change(function(){
            alert('do this')
        });
        $('section label.checkbox input').click(function(e) {
            unsetPolylines();
            unsetMarkers();
            var filterParams = getSelectedCriteria();
            filterEquipments(filterParams);
            e.stopPropagation()
        });

        // handle search
        $('form#search #keyword').keyup(function(){
            var query = $(this).val();
            if (query.length < 2) return;
            var endpoint = "{% url 'search' %}";
            var params = {format: 'json', query: query};
            $('body, button').css('cursor','wait');
            $.getJSON(endpoint, params, function(data) {
                $('body, button').css('cursor','default');
                if (data.error){
                    $('div#top-notice-ctnr span').html(data.error).addClass('failure');
                    $('#top-notice-ctnr').fadeIn().delay(5000);
                } else {
                    $('.empty-grid').remove();
                    var fibers = data.lines;
                    var devices = data.devices;
                    var techies = data.techies;
                    if (fibers.length>0 || devices.length>0 || techies.length>0) $('#suggestions-for-view').fadeIn();
                    populateFibers(fibers);
                    populateDevices(devices);
                    populateTechies(techies)
                }
            });
            return false
        });
        $(document).on('click', 'div#suggestions-for-view section div.result ul li', function(event) {
            var equipmentType = $(this).find('a').data('type');
            var pKey = $(this).find('a').data('key');
            var name = $(this).find('a').text();
            var index = -1;

            if (equipmentType == 'device') {
                var marks = ikwen.currentMarkerListOnTheMap;
                for(var i = 0, len = marks.length; i < len; i++) {
                    if (marks[i].deviceId === pKey) {
                        index = i;
                        break;
                    }
                }
                if (index !== -1){
                    var deviceMarker =  ikwen.currentMarkerListOnTheMap[index];
                    var myLatlng = deviceMarker.position;
                    var options = {
                        center: myLatlng,
                        zoom: 8,
                        mapTypeId: google.maps.MapTypeId.ROADMAP
                    };
                    map.panTo(myLatlng);
                    deviceMarker.setAnimation(google.maps.Animation.BOUNCE);
                    setTimeout(function(){deviceMarker.setAnimation(null); }, 10000);
                }
                $('div#suggestions-for-view div.close').click()
            }
            if (equipmentType == 'fiber') {
                var polylines = ikwen.polylines;
                for(var j = 0, len = polylines.length; j < len; j++) {
                    if (polylines[j].fiberId == pKey) {
                        index = j;
                        break;
                    }
                }
                if (index != -1){
                    var fiberLine =  ikwen.polylines[index],
                        coordList = fiberLine.getPath().getArray();
                    if (fiberLine.getPath().getArray().length > 0){
                        var coords = coordList[0],
                        plat = coords.lat(),
                        plng = coords.lng(),
                        center = new google.maps.LatLng(plat, plng),
                        lineSymbol = {
                            path: google.maps.SymbolPath.CIRCLE,
                            scale: 8,
                            strokeColor: '#393'
                        };
                        map.setOptions({zoom: 17});
                        fiberLine.setOptions({strokeColor: '#00FFaa'});
                        map.panTo(center);
                        fiberLine.setOptions({icons: [{icon: lineSymbol, offset: '100%'}],});
                        animateCircle(fiberLine)
                    }
                    else{
                        $('div#top-notice-ctnr span').html("This optical fiber has not yet been drawed");
                        $('#top-notice-ctnr').fadeIn().delay(5000);
                    }
                }
                $('div#suggestions-for-view div.close').click()
            }
            if (equipmentType ==  'techie') {
                var username = $(this).find('a').data('techname');
                $('#techie-name').fadeIn().attr('data-techieid', pKey ).find('span:first-child').text(name);
                $('#techie-name').removeClass('hidden').fadeIn();
                getTechieInstallation(pKey)
            }
            // lauch my request
            return false
        });

        $('#cancel-techie').click(function() {
            $('#techie-name').fadeOut().data('tachieid', '' ).find('span:first-child').text('')
        });

        function populateFibers(fibers) {
            $('ul.fiber li.line').not('.tpl').remove();
            if (fibers.length == 0) {
                var $emptyRow = $('<div class="empty-grid" colspan="10">No data found</div>');
                $emptyRow.insertBefore('ul.fiber li.line.tpl');
                return
            }
            var $list = $('<div></div>');
            for (var i = 0; i < fibers.length; i++) {
                var $newRow = $('ul.fiber li.line.tpl').clone().removeClass('tpl');
                $newRow = applyFiberTemplate($newRow, fibers[i]).show();
                $list.append($newRow)
            }
            $list.children().insertBefore('ul.fiber li.line.tpl')
        }
        function applyFiberTemplate($tplRow, fiber) {
            $tplRow.find('a').attr('data-type', 'fiber');
            $tplRow.find('a').attr('data-key', fiber.id);
            $tplRow.find('a').text(fiber.name);
            return $tplRow
        }

        function populateDevices(devices) {
            $('ul.device li.line').not('.tpl').remove();
            if (devices.length == 0) {
                var $emptyRow = $('<div class="empty-grid" colspan="10">No data found</div>');
                $emptyRow.insertBefore('ul.device li.line.tpl');
                return
            }
            var $list = $('<div></div>');
            for (var i = 0; i < devices.length; i++) {
                var $newRow = $('ul.device li.line.tpl').clone().removeClass('tpl');
                $newRow = applyDeviceTemplate($newRow, devices[i]).show();
                $list.append($newRow)
            }
            $list.children().insertBefore('ul.device li.line.tpl')
        }
        function applyDeviceTemplate($tplRow, device) {
            $tplRow.find('a').attr('data-type', 'device');
            $tplRow.find('a').attr('data-key', device.id);
            $tplRow.find('a').text(device.name);
            return $tplRow
        }

        function populateTechies(techies) {
            $('ul.techie li.line').not('.tpl').remove();
            if (techies.length == 0) {
                var $emptyRow = $('<div class="empty-grid" colspan="10">No data found</div>');
                $emptyRow.insertBefore('ul.techie li.line.tpl');
                return
            }
            var $list = $('<div></div>');
            for (var i = 0; i < techies.length; i++) {
                var $newRow = $('ul.techie li.line.tpl').clone().removeClass('tpl');
                $newRow = applyTechieTemplate($newRow, techies[i]).show();
                $list.append($newRow)
            }
            $list.children().insertBefore('ul.techie li.line.tpl')
        }
        function applyTechieTemplate($tplRow, techie) {
            var firstName = '';
            var lastName = '';
            var finalName = '';
            if (techie.first_name)
                finalName += techie.first_name;
            if (techie.lastName)
                finalName += techie.lastName;
            $tplRow.find('a').attr('data-type', 'techie');
            $tplRow.find('a').attr('data-key', techie.id);
            $tplRow.find('a').attr('data-techname', techie.username);
            if (finalName.length > 0)
                $tplRow.find('a').text(finalName);
            else
                $tplRow.find('a').text( techie.username);
            return $tplRow
        }
        $("span#erase").click(function() {
            unsetPolylines();
            unsetMarkers();
            $('.recents-equipments').removeClass('active');
            $('section#fiber  a').removeClass('active');
            $('section#device  a').removeClass('active');
            $('section#city  a').removeClass('active');
            return false
        });
        $('#suggestions-for-view .close').click(function() {
            $(this).parent('#suggestions-for-view').hide()
        });
        $('input[name="datefilter"]').daterangepicker({
              autoUpdateInput: false,
              locale: {
                  cancelLabel: 'Clear'
              }
        });
        $('input[name="datefilter"]').on('apply.daterangepicker', function(ev, picker) {
            $(this).val(picker.startDate.format('DD/MM/YYYY') + ' - ' + picker.endDate.format('DD/MM/YYYY'));
{#                    var string_date = $('#daterange').val($(this).val(picker.startDate.format('MM/DD/YYYY') + ' - ' + picker.endDate.format('MM/DD/YYYY')))#}
              string_date = (picker.startDate.format('DD/MM/YYYY') + ' - ' + picker.endDate.format('DD/MM/YYYY'))
        });

        $('input[name="datefilter"]').on('cancel.daterangepicker', function(ev, picker) {
            $(this).val('');
            string_date = ''
        });

        $("#add-coords").click(function () {
            $('#lightbox .dialog.new-coordinate input').val('');
            $('#lightbox .dialog.new-coordinate').show();
            $('#lightbox .dialog.new-device').hide();
            $('#lightbox').fadeIn().show()
        });
        $('#lightbox .dialog.new-coordinate button.validate').click(function () {
            var rawCoords = $('#lightbox .dialog.new-coordinate input').val();
            if (rawCoords == ''){
                alert('No coordinates entered');
                $('#lightbox .dialog.new-coordinate input').focus();
                return
            }
            var coords = rawCoords.split(';');
            if (coords.length != 2){
                alert('Respect the format please');
                $('#lightbox .dialog.new-coordinate input').val('');
                $('#lightbox .dialog.new-coordinate input').focus();
                return
            }
            var latitude = coords[0];
            var longitude = coords[1];
            addMarkerToMap(latitude, longitude, '', 'New device', "{% static 'img/grey_pin.png' %}");
            var myLatlng = new google.maps.LatLng(latitude, longitude);
            map.panTo(myLatlng);
            closeLightbox();

            $('form#equipment input.latitude').val(latitude);
            $('form#equipment input.longitude').val(longitude);
            $('form#equipment input.origin').val('home');
            $("#close").addClass('lastMarkerAdded');
            setNewDevice()
        });
        $('#close').click(function(){
            closeLightbox();
            if ($this.hasClass('lastMarkerAdded')) {
                deleteLastMarker();
                $("#close").removeClass('lastMarkerAdded')
            }
        });
        $('#lightbox .dialog.new-device button.cancel').click(function(){
            deleteLastMarker();
            closeLightbox()
        });

        $('button.cancel').click(function(){
            closeLightbox()
        });


        var height = $(document).height();
        $('#page-content-wrapper').css({'height': height, 'marginTop':0});
        $('#filter').css({'height': height-150});

        $("#toggle-search-inp").click(function() {
            $('form#search').toggleClass('active')
        });
        function grabDeviveInformations(deviceId) {
            var endpoint = "{% url 'grab_device_info' %}";
            var params = {format: 'json', deviceId:deviceId};
            $('body, button').css('cursor','wait');
            $.getJSON(endpoint, params, function(data) {
                $('body, button').css('cursor','default');
                if (data.error){
                    $('div#top-notice-ctnr span').html(data.error).addClass('failure');
                    $('#top-notice-ctnr').fadeIn().delay(5000);
                } else {
                    var device = data.device;
                    var $newRow = $('div.tooltip-html-text.tpl').clone().removeClass('tpl');
                    return applyDeviceTooltipTemplate($newRow, device);

                }
            })
        }

        function applyDeviceTooltipTemplate($tplRow, device) {
            var description = "<em class='text-muted'> &lt;No description&gt;</em>",
                    noImg = "no_photo.png",
                    strPhotoUrl = device.photo,
                    f = strPhotoUrl.search(noImg)

            if(strPhotoUrl.search(noImg) != -1) $tplRow.find('span.view-img a').remove()
            $tplRow.attr('id', device.id);
            $tplRow.find('h4').text(device.name);
            $tplRow.find('.photo').css('background-image', 'url(' + device.photo + ')');
            if (device.description != '') description = device.description
            $tplRow.find('.desc').html(description);
            $tplRow.find('.admin a').attr('href', device.admin_url);
            $tplRow.find('.reload a').attr('deviceid', device.id);
            $tplRow.find('.created span').text(device.created_on);
            $tplRow.find('.techie span').text(device.techie);
            return $tplRow
        }

        function applyFiberTooltipTemplate($tplRow, fiber) {
            var description = "<em class='text-muted'> &lt;No description&gt;</em>";
            $tplRow.attr('id', fiber.id);
            if (fiber.techie == "{{ request.user.get_full_name }}"){
                $tplRow.find('.edit-lnk .admin a').attr('fiberid', fiber.id);
            }
            $tplRow.find('.edit-lnk .reload a').attr('fiberid', fiber.id);
            $tplRow.find('h4').text(fiber.name);
            if (fiber.description != '') description = fiber.description
            $tplRow.find('div.description span').html(description)
            $tplRow.find('span.admin a').attr('href', fiber.admin_url);
            $tplRow.find('.created-on span').text(fiber.created);
            $tplRow.find('.distance span').text(fiber.distance);
            $tplRow.find('.techie span').text(fiber.techie);
            return $tplRow
        }


        // from Here we manage line Measures
        $('#measure-line').click(function(e){
            if ($(this).parent('.action').hasClass('.turn-back')){
                prepareDefaultUI();
{#                reloadMap()#}
            }else {
                prepareUIforLineMeasuring();
                var lineSymbol = {
                  path: 'M 0,-1 0,1',
                  strokeOpacity: 1,
                  scale: 1
                };
                ikwen.polylines = [];
                ikwen.currentMarkerListOnTheMap = [];
                ikwen.currentMarkerDataListOnTheMap = [];
                map.setOptions({draggableCursor: 'default'});
                var poly = new google.maps.Polyline({
{#                strokeColor: '#000000',#}
                    strokeWeight: 1,
                    strokeOpacity: 0,
                    icons: [{
                        icon: lineSymbol,
                        offset: '0',
                        repeat: '10px'
                      }]
                });
                poly.setMap(map);
                ikwen.polylines.push(poly);

            // Add a listener for the click event
                map.addListener('click', addLatLng);
            }

        });

        $('form#line-search button').on('click', function() {
            var lineCoords = getPolylinePath(),
                line = $('form#line-search  input:hidden').val(),
                    lineDistance = $('#current-polyline-length').attr('distance');

            if (line == ""){
                $('#top-notice-ctnr span').html('Choose a line first please');
                $('#top-notice-ctnr').removeClass('hidden').fadeIn().delay(7000).fadeOut();
                return false
            }

            saveLinePath(line, lineCoords, lineDistance, false);
            $('#top-notice-ctnr span').html('line saved!');
            $('#top-notice-ctnr').removeClass('hidden').fadeIn().delay(7000).fadeOut();
        });
{#        Here are the application's useful functions; they are build for both drawing and equipement management #}
{#    drawing and equipement management     #}




        // set a marker to the map
        function addMarkerToMap(lat, long, deviceId, htmlMarkupForInfoWindow, iconImg){
            var infowindow = new google.maps.InfoWindow();
            lastMarkerId = ikwen.currentMarkerListOnTheMap.length;
            var myLatLng = new google.maps.LatLng(lat, long);
            var marker = new google.maps.Marker({
                id: lastMarkerId - 1,
                position: myLatLng,
                map: map,
                icon: iconImg,
                animation: google.maps.Animation.DROP,
                deviceId: deviceId,
                {% if not is_mobile %}
                    draggable:true,
                {% else %}
                    draggable:false,
                {% endif %}

            });
            var markerData = {id: deviceId, lat: lat, lng:long, icon:iconImg}
            ikwen.currentMarkerListOnTheMap.push(marker);
            ikwen.currentMarkerDataListOnTheMap.push(markerData);
            //Gives each marker an Id for the on click markerCount++;
            // Creates the event listener for clicking the marker
            // and places the marker on the map
            google.maps.event.addListener(marker,"dragstart",function(event){
                ikwen.startDragPosition =  this.getPosition();

            });
            google.maps.event.addListener(marker,'dragend',function(event) {
                var index = ikwen.currentMarkerListOnTheMap.indexOf(marker);
                ikwen.currentMarkerListOnTheMap.splice(index, 1);
                ikwen.currentMarkerDataListOnTheMap.splice(index, 1);
                ikwen.currentMarkerListOnTheMap.push(marker);
                ikwen.currentMarkerDataListOnTheMap.push(markerData);
                if (confirm("Do you confirm the new position?")){
                    changeDevicePosition(deviceId, event.latLng.lat(), event.latLng.lng())
                }else{
                    changeMarkerPosition(marker)
                }
            });

                    {% if not is_mobile %}
                google.maps.event.addListener(marker, 'mouseover', (function(marker, markerCount)
                    {% else %}
                        google.maps.event.addListener(marker, 'click', (function(marker, markerCount)
                    {% endif %}
            {

                return function() {
                    $('.gm-style-iw').parent().hide();
{#                    var htmlInfo = grabDeviveInformations(marker.deviceId)#}
                    var endpoint = "{% url 'grab_device_info' %}";
                    var params = {format: 'json', deviceId:deviceId};
                    $.getJSON(endpoint, params, function(data) {
                        var device = data.device;
                        var $newRow = $('div.tooltip-html-text.tpl').clone().removeClass('tpl');
                        var htmContent = applyDeviceTooltipTemplate($newRow, device);
                        $newRow.find('.spinner').hide();
                        var strHtmContent = htmContent.prop('outerHTML');
                        infowindow.setContent(strHtmContent);
                    });

{#                    infowindow.setContent(htmlInfo); #}
                    infowindow.open(map, marker); }
            })(marker, markerCount));
            //Pans map to the new location of the marker
{#                    map.panTo(myLatLng)#}
        }

    // Add new device to the map directly .lawless

        var dbClickListener = google.maps.event.addListener(map,'dblclick',function(event) {
            var lat = event.latLng.lat() , lng = event.latLng.lng();
            addMarkerToMap(lat, lng, '', 'New device', "{% static 'img/grey_pin.png' %}");
            document.getElementById('latlongclicked').value = lat + ';' + lng;
            $('form#equipment input.latitude').val(lat);
            $('form#equipment input.longitude').val(lng);
            $('form#equipment input.origin').val('home');
            setNewDevice()
        });

 // View mouse current position on the map
        google.maps.event.addListener(map,'mousemove',function(event) {
            document.getElementById('latspan').innerHTML = event.latLng.lat();
            document.getElementById('lngspan').innerHTML = event.latLng.lng();
{#                  document.getElementById('latlong').innerHTML = event.latLng.lat() + '|' + event.latLng.lng()#}
        });


        function drawPoly(fibers){
            var polylines = constructPlolyCoords(fibers);
            setPoly(polylines)
        }

        function constructPlolyCoords(fibers){
            var fiberLines = [];
            for (var j=0; j<fibers.length; j++){
                var fiberLine = fibers[j]['fiberline'];
                var line_coords = fibers[j]['line_coords'];
                var fiberLineCoord = [];
                for (var k=0; k<line_coords.length; k++){
                    var pos = {};
                    pos.lat = parseFloat(line_coords[k].latitude);
                    pos.lng = parseFloat(line_coords[k].longitude);
                    fiberLineCoord.push(pos);
                }
                var fiber={'fiberline':fiberLine, 'line_coords':fiberLineCoord};
                fiberLines.push(fiber)
            }
            return fiberLines
        }



        function createInfoWindow(poly, content) {
            google.maps.event.addListener(poly, 'click', function(event) {
                // infowindow.content = content;
                infowindow.setContent(content);

                // infowindow.position = event.latLng;
                infowindow.setPosition(event.latLng);
                infowindow.open(map);
            });
        }

        function setPoly(fiberLines){
            for (var i = 0; i < fiberLines.length; i++) {
                var id =fiberLines[i]['fiberline'].id;
                var pathStyle = new google.maps.Polyline({
                    fiberId: fiberLines[i]['fiberline'].id,
                    path: fiberLines[i]['line_coords'],
                    geodesic: true,
                    strokeColor: fiberLines[i]['fiberline'].color,
                    strokeOpacity: 1.0,
                    strokeWeight: 3,
                    map: map,
                    visible: true
                });
                pathStyle.setMap(map);
                ikwen.polylines.push(pathStyle);
                var fiberline = fiberLines[i]['fiberline'],
                     $newRow = $('div.fiber-tooltip-html-text.tpl').clone().removeClass('tpl');
                var htmContent = applyFiberTooltipTemplate($newRow, fiberline);
                var strHtmContent = htmContent.prop('outerHTML');
                createInfoWindow(pathStyle, strHtmContent)

            }
        }
{#        change marker position#}
        function changeMarkerPosition(marker) {
            var lat = ikwen.startDragPosition.lat();
            var lng = ikwen.startDragPosition.lng();
            var latlng = new google.maps.LatLng(lat, lng);
            marker.setPosition(latlng);
        }
        // set markers to invisible or remove every markers from the marker list
        function unsetMarkers() {
            //Loop through all the markers and remove
            for (var i = 0; i < ikwen.currentMarkerListOnTheMap.length; i++) {
                ikwen.currentMarkerListOnTheMap[i].setMap(null);
            }
            ikwen.currentMarkerListOnTheMap = [];
            ikwen.currentMarkerDataListOnTheMap = [];
        }
        function unsetPolylines() {
            for (i=0; i<ikwen.polylines.length; i++) {
              ikwen.polylines[i].setMap(null); //or line[i].setVisible(false);
            }
        }
        var deleteLastMarker = function() {
            var index = ikwen.currentMarkerListOnTheMap.length;
{#            var marker = ikwen.currentMarkerListOnTheMap.length[ - 1];#}
            ikwen.currentMarkerListOnTheMap[index-1].setMap(null);
            ikwen.currentMarkerListOnTheMap.pop();
            ikwen.currentMarkerDataListOnTheMap.pop();
        };



    // Save Equipment using AJAX
        function saveEquipment(category, latitude, longitude, desc) {
            var endpoint = "{% url 'save_device' %}";
            var params = {format: 'json', category: category, description:desc, latitude:latitude, longitude:longitude};
            $('body, button').css('cursor','wait');
            $.getJSON(endpoint, params, function(data) {
                $('body, button').css('cursor','default');
                if (data.error){
                    $('div#top-notice-ctnr span').html(data.error).addClass('failure');
                    $('#top-notice-ctnr').fadeIn().delay(5000);
                } else {
                    var device = data.device,
                    latitude = parseFloat(device.latitude),
                    longitude = parseFloat(device.longitude),
                    deviceId = device.id;
                    if (device.image)    photo = device.image;
                    else  photo = "{% static 'img/no_photo.png' %}";
                    htmlText = '';

                    if (device.category.icon) {
                        iconImg =  "{{ media_root }}" + device.category.icon
                    }
                    addMarkerToMap(latitude, longitude, deviceId, htmlText, iconImg);
                     $('#top-notice-ctnr span').html('Equipement Saved');
                     $('#top-notice-ctnr').removeClass('hidden').fadeIn().delay(7000).fadeOut();
                }
            });
            return false
        }



        function filterEquipments(params) {
            var endpoint = "{% url 'filter_network_data' %}";
            var techieId = $('#techie-name').data('techieid');
            params.format ='json';
            params.techieId = techieId;
            params.string_date = string_date;

            $('body, button').css('cursor','wait');
            $.getJSON(endpoint, params, function(data) {
                $('body, button').css('cursor','default');
                if (data.error){
                    $('div#top-notice-ctnr span').html(data.error).addClass('failure');
                    $('#top-notice-ctnr').fadeIn().delay(5000);
                } else {
                    var myLatlng = new google.maps.LatLng(3.80627, 11.50758);
                        var options = {
                            center: myLatlng,
                            zoom: 10,
                            mapTypeId: google.maps.MapTypeId.ROADMAP
                        };
{#                            if (equipmentType == "fiber"){#}
                        // draw polyline with the revovered coords
                        var lineCoords = data.lines;
                        drawPoly(lineCoords);
{#                            } else {#}
                        // positionning recovered devices on the map
                        var devices = data.devices;
                        for (var i=0; i<=devices.length-1; i++){
                            latitude = parseFloat(devices[i].latitude);
                            longitude = parseFloat(devices[i].longitude);
                            deviceId = devices[i].id;
{#                                    htmlText = ('<h4>' + devices[i].name  + '</h4><p>' + devices[i].description  +"</p>");#}
                            if (devices[i].image)    photo = devices[i].image;
                            else  photo = "{% static 'img/no_photo.png' %}";
                            htmlText = '';

                            if (devices[i].category.icon) {
                                iconImg =  "{{ media_root }}" + devices[i].category.icon
                            }
                            addMarkerToMap(latitude, longitude, deviceId, htmlText, iconImg);
                        }
{#                            }#}
                }
            });
            return false
        }


        function addLatLng(event) {
            var poly = ikwen.polylines[0];

            // Because path is an MVCArray, we can simply append a new coordinate
            // and it will automatically appear.
            var path = poly.getPath();
                path.push(event.latLng);
            var distance = calculateDistance(path);

                $('#current-polyline-length').text(distance + 'm').attr('distance', distance);
            // Add a new marker at the new plotted point on the polyline.
{#            var marker = new google.maps.Marker({#}
{#                position: event.latLng,#}
{#                title: '#' + path.getLength(),#}
{#                map: map#}
{#            });#}
{#            ikwen.currentMarkerListOnTheMap.push(marker)#}
        }

        function prepareUIforLiveDrawing() {
            $('div#tools').hide()
        }

        function prepareUIforLineMeasuring() {
{#            $("span#erase").click();#}
            $("span#erase").parent('.action').hide();
            $("span#add-coords").hide();
            $("input#keyword").hide();
            $("span#live-drawing").parent('.action').hide();
            $("div#toggle-search-inp").hide();
            $("div#current-polyline-length").show();
            $("span#view-all-equipments").parent('.action').show()
        }

        function prepareDefaultUI() {
            $("span#erase").click();
            $("span#erase").parent('.action').show();
            $("span#add-coords").show();
            $("span#live-drawing").parent('.action').show();
            $("input#keyword").show();
            $("div#toggle-search-inp").show();
            $("div#current-polyline-length").hide();
            $("span#view-all-equipments").parent('.action').hide()
        }

        function calculateDistance(fiberLinePath) {
            if (fiberLinePath) {
                var coordList = fiberLinePath.getArray(),polylineLength = 0, polyPath = [], coords = [];
                for (var i=0; i<coordList.length; i++){
                    if(typeof coordList[i] !== 'undefined'){
                        var lat = coordList[i].lat(),
                            lng = coordList[i].lng(),
                            coord = lat + ',' + lng;
                        coords.push(coord)
                    }
                }
                for (var j=0; j<coords.length; j++){
                    var coordinate = coords[j].split(','),
                            plat = parseFloat(coordinate[0]), plng = parseFloat(coordinate[1]);
                    var pointPath = new google.maps.LatLng(plat,plng);
                    polyPath.push(pointPath);
                    if (j >= 1){
                        polylineLength += google.maps.geometry.spherical.computeDistanceBetween(polyPath[j], polyPath[j-1]);
                    }
                }
                return polylineLength.toFixed(0)
            }
        }


        function changeDevicePosition(deviceId, latitude, longitude){
            var endpoint = "{% url 'change_device_position' %}";
            var params = {format: 'json', deviceId:deviceId, latitude: latitude, longitude:longitude};
            $('body, button').css('caursor','wait');
            $.getJSON(endpoint, params, function(data) {
                $('body, button').css('cursor','default');
                if (data.error){
                    $('div#top-notice-ctnr span').html(data.error).addClass('failure');
                    $('#top-notice-ctnr').fadeIn().delay(5000);
                } else {
                    var myLatlng = new google.maps.LatLng(latitude, longitude);
                    var options = {
                        center: myLatlng, zoom: 22,
                        mapTypeId: google.maps.MapTypeId.ROADMAP
                    };
                    map.panTo(myLatlng)
                }
            })
        }

        function closeLightbox(){
            $('#lightbox .dialog.new-coordinate input').val('');
            $('#lightbox .dialog.new-device input').val('');
            $('#lightbox .dialog.new-device textarea').text('');
            $('#lightbox .dialog.new-coordinate input').val('');
            $('#lightbox .dialog.new-coordinate').hide();
            $('#lightbox').fadeIn().hide()
        }
        function setNewDevice() {
            $('#lightbox .dialog.new-device').show();
            $('#lightbox .dialog.new-coordinate').hide();
            $('#lightbox').fadeIn().show()
        }

        function getSelectedCriteria(){
            fiberStatus = '';
            fiberType = '';
            deviceCategory = '';
            deviceStatus = '';
            $('section label.checkbox').find('input:checkbox:checked').each(function() {
                if ($(this).hasClass('fiberstatus')) fiberStatus += ($(this).val() + ',');
                if ($(this).hasClass('fibertype')) fiberType += ($(this).val() + ',');
                if ($(this).hasClass('devicecategory')) deviceCategory += ($(this).val() + ',');
                if ($(this).hasClass('devicestatus')) deviceStatus += ($(this).val() + ',')

            });
            return {
                fiberStatus: fiberStatus,
                fiberType: fiberType,
                deviceCategory: deviceCategory,
                deviceStatus: deviceStatus
            }
        }

        function getSelectedDevice(deviceId) {
            var endpoint = "{% url 'get_selected_device' %}";
            var params = {format: 'json', deviceId: deviceId};
            $('body, button').css('cursor','wait');
            $.getJSON(endpoint, params, function(data) {
                $('body, button').css('cursor','default');
                if (data.error){
                    $('div#top-notice-ctnr span').html(data.error).addClass('failure');
                    $('#top-notice-ctnr').fadeIn().delay(5000);
                } else {
                        // positionning recovered devices on the map
                    var device = data.devices;
                    var latitude = parseFloat(device.latitude);
                    var longitude = parseFloat(device.longitude);
                    var myLatlng = new google.maps.LatLng(latitude, longitude);
                    var options = {
                        center: myLatlng, zoom: 10,
                        mapTypeId: google.maps.MapTypeId.ROADMAP
                    };

                        latitude = parseFloat(device.latitude);
                        longitude = parseFloat(device.longitude);
                        deviceId = device.longitude;
{#                                htmlText = ('<h4>' + device.name  + '</h4><p>' + device.description  +"</p>");#}
                         if (device.image)    photo = device.image;
                            else  photo = "{% static 'img/no_photo.png' %}";
                            htmlText = '';

                        if (device.category.icon) {
                            iconImg =  "{{ media_root }}" + device.category.icon
                        }
                        addMarkerToMap(latitude, longitude, deviceId, htmlText, iconImg);
                }
            });
            return false
        }
        function getSelectedFiber(fiberId) {
            var endpoint = "{% url 'get_selected_fiber' %}";
            var params = {format: 'json', fiberId: fiberId,};
            $('body, button').css('cursor','wait');
            $.getJSON(endpoint, params, function(data) {
                $('body, button').css('cursor','default');
                if (data.error){
                    $('div#top-notice-ctnr span').html(data.error).addClass('failure');
                    $('#top-notice-ctnr').fadeIn().delay(5000);
                } else {
                    var myLatlng = new google.maps.LatLng(3.80627, 11.50758);
                    var options = {
                        center: myLatlng, zoom: 14,
                        mapTypeId: google.maps.MapTypeId.ROADMAP
                    };
                    // draw polyline with the revovered coords
                    var lineCoords = data.lines;
                    drawPoly(lineCoords)
                }
            });
            return false
        }

        function getTechieInstallation(techieId) {
            var endpoint = "{% url 'get_techie_installation' %}";
            var params = {format: 'json', techieId: techieId, stringDate: string_date};
            $('body, button').css('cursor','wait');
            $.getJSON(endpoint, params, function(data) {
                $('body, button').css('cursor','default');
                if (data.error){
                    $('div#top-notice-ctnr span').html(data.error).addClass('failure');
                    $('#top-notice-ctnr').fadeIn().delay(5000);
                } else {
                    var myLatlng = new google.maps.LatLng(3.80627, 11.50758);
                    var options = {
                        center: myLatlng, zoom: 10,
                        mapTypeId: google.maps.MapTypeId.ROADMAP
                    };
                    // draw polyline with the revovered coords
                    var lineCoords = data.lines;
                    drawPoly(lineCoords);
                    // positionning recovered devices on the map
                    var devices = data.devices;
                    for (var i=0; i<=devices.length-1; i++){
                        latitude = parseFloat(devices[i].latitude);
                        longitude = parseFloat(devices[i].longitude);
                        deviceId = devices[i].id;
{#                                htmlText = ('<h4>' + devices[i].name  + '</h4><p>' + devices[i].description  +"</p>");#}
                         if (devices[i].image)    photo = devices[i].image;
                            else  photo = "{% static 'img/no_photo.png' %}";
                            htmlText = '';

                        if (devices[i].category.icon) {
                            iconImg =  "{{ media_root }}" + devices[i].category.icon
                        }
                        addMarkerToMap(latitude, longitude, deviceId, htmlText, iconImg);
                        $('div#suggestions-for-view div.close').click()
                    }
                }
            });
            return false
        }

        function addNewLineLatLng(event) {
            var poly = ikwen.polylines[0];

            // Because path is an MVCArray, we can simply append a new coordinate
            // and it will automatically appear.
            var path = poly.getPath();
                path.push(event.latLng);
            var distance = calculateDistance(path);
            $('#current-polyline-length').text(distance + ' Meters').attr('distance', distance);

        }


        function initLiveDrawingUI() {
            $("#current-polyline-length").show()
            $('button#save-fiber-modification').hide()
            $('#equipement-viewer').fadeOut("slow", function (e) {
                $('div#ld-tools-content').show().removeClass('hidden')
            }).hide();
            ikwen.polylines = [];
{#            ikwen.currentMarkerListOnTheMap = [];#}
            map.setOptions({draggableCursor: 'default'});
            var poly = new google.maps.Polyline({
            strokeColor: '#000000',
            strokeOpacity: 1.0,
            strokeWeight: 3
            });
            poly.setMap(map);
            ikwen.polylines.push(poly);
            var deleteMenu = new DeleteMenu();

            google.maps.event.addListener(poly, 'rightclick', function(e) {
              // Check if click was on a vertex control point
                if (e.vertex == undefined) {
                    return;
                }
                deleteMenu.open(map, poly.getPath(), e.vertex);
            });
        // Add a listener for the click event
            clickListener = map.addListener('click', addNewLineLatLng);
        }

        function activateLineOptimizing(){
            // reset options.
            var line = ikwen.polylines[0];
            line.setOptions({strokeColor: '#00FFaa', editable: true});
            google.maps.event.removeListener(clickListener);
            google.maps.event.addListener(line, "dragend", getPolylinePath);
            google.maps.event.addListener(line.getPath(), "insert_at", getPolylinePath);
            google.maps.event.addListener(line.getPath(), "remove_at", getPolylinePath);
            google.maps.event.addListener(line.getPath(), "set_at", getPolylinePath);
        }

        function getPolylinePath() {
            var path = ikwen.polylines[0].getPath();
            var len = path.getLength();
            var coordStr = "";
            for (var i = 0; i < len; i++) {
                coordStr += path.getAt(i).toUrlValue(10) + ";";
            }
            return coordStr;
        }

        function saveLinePath(line, strCoords, distance, isUpdate) {
            var endpoint = "{% url 'save_live_optical_fiber_coords' %}";
            var params = {format: 'json', line: line, strCoords:strCoords, distance:distance};
            $('body, button').css('cursor','wait');
            $.getJSON(endpoint, params, function(data) {
                $('body, button').css('cursor','default');
                if (data.error){
                    $('div#top-notice-ctnr span').html(data.error).addClass('failure');
                    $('#top-notice-ctnr').fadeIn().delay(5000);
                } else {
                    if(!isUpdate){
                        unsetMarkers();
                        unsetPolylines()
                        $('#top-notice-ctnr span').html('Line path saved');
                        $('#top-notice-ctnr').removeClass('hidden').fadeIn().delay(7000).fadeOut();
                    }else {
                        $('#top-notice-ctnr span').html('Line updated');
                        $('#top-notice-ctnr').removeClass('hidden').fadeIn().delay(3000).fadeOut();
                    }
                    var currentLine = data.line
                    updateLineCoords(currentLine)
{#                    Update local storage #}
                }
            });
            return false
        }
        $(document).on('click', 'div.tooltip-html-text span.view-img a', function(event) {
            event.preventDefault();
            $(this).parents('div.tooltip-html-text').find('.stage').animate({height: '150px'});
            return false
        });

        function updateFiberDIstance(event) {
             var poly = ikwen.polylines;
            // Because path is an MVCArray, we can simply append a new coordinate
            // and it will automatically appear.
{#            fiberId: fiberLines[i]['fiberline'].id,path: fiberLines[i]['line_coords'],#}
            for(var i=0; i<poly.length; i++){
                var currentPolyline = poly[i],
                fiberId = currentPolyline.fiberId

                var path = currentPolyline.getPath();
                    path.push(event.latLng);
                var distance = calculateDistance(path),
                params = {format: 'json', fiberId:fiberId, distance:distance}
                $.getJSON('{% url 'update_fibers_distance' %}', params, function(data) {

                });

            }
        }
        $('#dist-reload').click(function (e) {
            updateFiberDIstance(e)
        });

        checkNewAsset();
        setInterval(function() {
            checkNewAsset();
            updateLines()
        }, 60000);
        function checkNewAsset() {
            var poly = ikwen.fiberData
            $.getJSON('{% url 'check_new_fiber' %}', {'lastFiberId': lastFiberId}, function(resp) {
                if (resp.length > 0) {
                    drawPoly(resp)
                    var newFiberData = poly.concat(resp)
                    localStorage.setItem('fiberlines', JSON.stringify(newFiberData))
                    lastFiberId = resp[0]['fiberline'].id
                }
            });
            $.getJSON('{% url 'check_new_device' %}',  {'lastDeviceId': lastDeviceId}, function(resp) {
                if (resp.length > 0){
                    var d;
                    for (var j=0; j<resp.length; j++) {
                        d = resp[j];
                        html =  '';
                        addMarkerToMap(d.lat, d.lng, d.id, html, d.icon);
                    }
                    lastDeviceId = resp[0].id
                    localStorage.setItem('devices', JSON.stringify(ikwen.currentMarkerListOnTheMap))
                }

            })
            var last_updated_log_id = localStorage.getItem("last_log_updated_id")
            $.getJSON('{% url 'get_updated_fibers' %}',  {'last_updated_log_id': last_updated_log_id}, function(resp) {

                if (resp.lines.length > 0){
                    var localFibers = JSON.parse(localStorage.getItem("fiberlines"))
                    for (var i = 0; i < resp.lines.length; i++) {
                        for (var j = 0; j < localFibers.length; j++) { //loop over the collection
                            if (localFibers[j]['fiberline'].id === resp.lines[i]['fiberline'].id) { //see if ids match
                                localFibers.splice(j, 1); //remove item from array
{#                                console.log(localFibers[j]['fiberline']);#}

                            }
                        }
                    }
                    var localLines = JSON.stringify(localFibers)
                    var end = localLines.length - 1;
                    var localFiberData = localLines.substr(0, end) + ',' + JSON.stringify(resp.lines).substring(1)
                    localStorage.setItem("fiberlines", localFiberData);
                    localStorage.setItem("last_log_updated_id", resp.last_log_updated_id);
                    drawPoly(resp.lines);

                }

            });
        }

        function checkDataIntegrity(){
            $.getJSON('{% url 'check_data_integrity' %}',  {'lastFiberId': lastFiberId}, function(resp) {
                if (resp.deleted_devices.length > 0){
                    var localDevices = JSON.parse(localStorage.getItem("devices"))

                    var device_to_delete = resp.deleted_devices
                    for (var i = 0; i < device_to_delete.length; i++) {
                        for (var j = 0; j < localDevices.length; j++) { //loop over the collection
                            if (localDevices[j].id === device_to_delete[i]) { //see if ids match
                                localDevices.splice(j, 1); //remove item from array
                                console.log(localDevices[j]);
{#                              break; //exit loop#}
                            }
                        }
                    }
                    localStorage.setItem("devices", JSON.stringify(localDevices))
                }
                if (resp.deleted_fibers.length > 0){
                    var localFibers = JSON.parse(localStorage.getItem("fiberlines"))
                    var fiber_to_delete = resp.deleted_fibers
                    for (var i = 0; i < fiber_to_delete.length; i++) {
                        for (var j = 0; j < localFibers.length; j++) { //loop over the collection
                            if (localFibers[j]['fiberline'].id === fiber_to_delete[i]) { //see if ids match
                                localFibers.splice(j, 1); //remove item from array
                                console.log(localFibers[j]['fiberline']);
{#                              break; //exit loop#}
                            }
                        }
                    }
                    localStorage.setItem("fiberlines", JSON.stringify(localFibers))
                }

            });
        }
        function updateLineCoords(line) {
            var updated = false
            var localFibers = JSON.parse(localStorage.getItem("fiberlines"))
            for (var j = 0; j < localFibers.length; j++) { //loop over the collection
                if (localFibers[j]['fiberline'].id == line['fiberline'].id) { //see if ids match
                    localFibers.splice(j, 1); //remove item from array
                    updated=true
                    break; //exit loop
                }
            }
            if (updated){
                var localLines = JSON.stringify(localFibers)
                var end = localLines.length - 1;
                var localFiberData = localLines.substr(0, end) + ',' + JSON.stringify(line) + ']'
                localStorage.setItem("fiberlines", localFiberData);


            }
        }
        function updateLines(){
            var fiberIds = grabFibersWithNoCoords()
            console.log(fiberIds);
            $.getJSON('{% url 'check_line_update' %}',  {'fiberIds': fiberIds.toString()}, function(resp) {
                if (resp.length > 0){
                    var localFibers = JSON.parse(localStorage.getItem("fiberlines"))
                    for (var i = 0; i < resp.length; i++) {
                        for (var j = 0; j < localFibers.length; j++) { //loop over the collection
                            if (localFibers[j]['fiberline'].id === resp[i]['fiberline'].id) { //see if ids match
                                localFibers.splice(j, 1); //remove item from array
{#                                console.log(localFibers[j]['fiberline']);#}
{#                              break; //exit loop#}
                            }
                        }
                    }
                    var localLines = JSON.stringify(localFibers)
                    var end = localLines.length - 1;
                    var localFiberData = localLines.substr(0, end) + ',' + JSON.stringify(resp).substring(1)
                    localStorage.setItem("fiberlines", localFiberData);
                    drawPoly(resp);
                }

            });
        }

        function grabFibersWithNoCoords() {
            var noCoordFibers = []
            var localFibers = JSON.parse(localStorage.getItem("fiberlines"))
            for (var j = 0; j < localFibers.length; j++) {
                if (localFibers[j]['line_coords'].length == 0) {
                    noCoordFibers.push(localFibers[j]['fiberline'].id)
                }
            }
            return noCoordFibers
        }


        $(document).on('click', 'div.fiber-tooltip-html-text div.edit-lnk .admin a', function(event) {
            if($('button#save-fiber-modification').hasClass('update-mode')) {
                $('#top-notice-ctnr span').html('You have an amendment in court; finish with it first');
                $('#top-notice-ctnr').removeClass('hidden').fadeIn().delay(7000).fadeOut();
                return false
            }
            var pKey = $(this).attr('fiberid')
            $('#save-fiber-modification').attr('fiberid', pKey)
            $('button#save-fiber-modification').fadeIn().addClass('update-mode')
            var index = -1;


            var polylines = ikwen.polylines;
            for(var j = 0, len = polylines.length; j < len; j++) {
                if (polylines[j].fiberId == pKey) {
                    index = j;
                    ikwen.index = j;
                    break;
                }
            }
            if (index != -1){
                var line = ikwen.polylines[index];
                line.setOptions({strokeColor: '#00FFaa', editable: true});
                google.maps.event.removeListener(clickListener);
                google.maps.event.addListener(line, "dragend", getlinePath);
                google.maps.event.addListener(line.getPath(), "insert_at", getlinePath);
                google.maps.event.addListener(line.getPath(), "remove_at", getlinePath);
                google.maps.event.addListener(line.getPath(), "set_at", getlinePath)
                var coordList = line.getPath().getArray();
                var coords = coordList[0],
                plat = coords.lat(),
                plng = coords.lng(),
                center = new google.maps.LatLng(plat, plng)
                map.panTo(center);
            }
            // lauch my request
            return false
        });
        $(document).on('click', 'div.fiber-tooltip-html-text div.edit-lnk .reload a', function(event) {
            var pKey = $(this).attr('fiberid')
            var localFibers = JSON.parse(localStorage.getItem("fiberlines"))
            for (var j = 0; j < localFibers.length; j++) { //loop over the collection
                if (localFibers[j]['fiberline'].id == pKey) { //see if ids match
                    localFibers.splice(j, 1);
                    ikwen.polylines[j].setMap(null)
                    infowindow.close();
                    $.getJSON('{% url 'get_specific_fiber_data' %}', {'fiberId': pKey}, function(resp) {
                        if (resp.length > 0) {
                            drawPoly(resp)

                            var localLines = JSON.stringify(localFibers)
                            var end = localLines.length - 1;
                            var localFiberData = localLines.substr(0, end) + ',' + JSON.stringify(resp[0]) + ']'
                            localStorage.setItem("fiberlines", localFiberData);
                        }
                    });
                    break; //exit loop
                }
            }
            return false
        });

        function getlinePath() {
            var path = ikwen.polylines[ikwen.index].getPath();
            var len = path.getLength();
            var coordStr = "";
            for (var i = 0; i < len; i++) {
                coordStr += path.getAt(i).toUrlValue(10) + ";";
            }
            return coordStr;
        }
        $('button#save-fiber-modification').click(function() {
            var polyLine = ikwen.polylines[ikwen.index]
            var path = ikwen.polylines[ikwen.index].getPath();
            var lineCoords = getlinePath(),
                line = $(this).attr('fiberid'),
                    lineDistance = calculateDistance(path);
            $(this).removeClass('update-mode').hide()
            polyLine.setOptions({strokeColor: '#000000', editable: false});
            saveLinePath(line, lineCoords, lineDistance, true);
        });
    })()

</script>
<script type="application/javascript">
    [].slice.call(document.querySelectorAll('.dropdown .nav-link')).forEach(function(el){
        el.addEventListener('click', onClick, false);
    });

    function onClick(e){
        e.preventDefault();
        var el = this.parentNode;
        el.classList.contains('show-submenu') ? hideSubMenu(el) : showSubMenu(el);
    }

    function showSubMenu(el){
        el.classList.add('show-submenu');
        document.addEventListener('click', function onDocClick(e){
{#            e.preventDefault();#}
            if(el.contains(e.target)){
                return;
            }
            document.removeEventListener('click', onDocClick);
            hideSubMenu(el);
        });
    }

    function hideSubMenu(el){
        el.classList.remove('show-submenu');
    }

    function animateCircle(line) {
        var count = 0, times = 0,
            intervalId = setInterval(function() {
                count = (count + 1) % 200;
                if (times >= 450) clearInterval(intervalId);
                times ++;
                var icons = line.get('icons');
                icons[0].offset = (count / 2) + '%';
                line.set('icons', icons);
            }, 20);
    }
    function createInfoWindow(poly, content) {
        google.maps.event.addListener(poly, 'click', function(event) {
            infowindow.content = content;
            infowindow.position = event.latLng;
            infowindow.open(map);
        });
    }
    function DeleteMenu() {
        this.div_ = document.createElement('div');
        this.div_.className = 'delete-menu';
        this.div_.innerHTML = 'Delete';

        var menu = this;
        google.maps.event.addDomListener(this.div_, 'click', function() {
          menu.removeVertex();
        });
    }
    DeleteMenu.prototype = new google.maps.OverlayView();

    DeleteMenu.prototype.onAdd = function() {
        var deleteMenu = this;
        var map = this.getMap();
        this.getPanes().floatPane.appendChild(this.div_);

        // mousedown anywhere on the map except on the menu div will close the
        // menu.
        this.divListener_ = google.maps.event.addDomListener(map.getDiv(), 'mousedown', function(e) {
            if (e.target != deleteMenu.div_) {
                deleteMenu.close();
            }
        }, true);
    };
    DeleteMenu.prototype.onRemove = function() {
        google.maps.event.removeListener(this.divListener_);
        this.div_.parentNode.removeChild(this.div_);

        // clean up
        this.set('position');
        this.set('path');
        this.set('vertex');
    };

    DeleteMenu.prototype.close = function() {
        this.setMap(null);
    };

    DeleteMenu.prototype.draw = function() {
        var position = this.get('position');
        var projection = this.getProjection();

        if (!position || !projection) {
          return;
        }
        var point = projection.fromLatLngToDivPixel(position);
        this.div_.style.top = point.y + 'px';
        this.div_.style.left = point.x + 'px';
    };
    /**
       * Opens the menu at a vertex of a given path.
       */
    DeleteMenu.prototype.open = function(map, path, vertex) {
        this.set('position', path.getAt(vertex));
        this.set('path', path);
        this.set('vertex', vertex);
        this.setMap(map);
        this.draw();
    };
/**
       * Deletes the vertex from the path.
       */
    DeleteMenu.prototype.removeVertex = function() {
        var path = this.get('path');
        var vertex = this.get('vertex');

        if (!path || vertex == undefined) {
          this.close();
          return;
        }

        path.removeAt(vertex);
        this.close();
    };

</script>